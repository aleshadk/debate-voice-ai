"use strict";var b=Object.create;var g=Object.defineProperty;var D=Object.getOwnPropertyDescriptor;var z=Object.getOwnPropertyNames;var S=Object.getPrototypeOf,k=Object.prototype.hasOwnProperty;var T=(e,n,r,t)=>{if(n&&typeof n=="object"||typeof n=="function")for(let s of z(n))!k.call(e,s)&&s!==r&&g(e,s,{get:()=>n[s],enumerable:!(t=D(n,s))||t.enumerable});return e};var y=(e,n,r)=>(r=e!=null?b(S(e)):{},T(n||!e||!e.__esModule?g(r,"default",{value:e,enumerable:!0}):r,e));var c=(e,n,r)=>new Promise((t,s)=>{var a=i=>{try{u(r.next(i))}catch(m){s(m)}},l=i=>{try{u(r.throw(i))}catch(m){s(m)}},u=i=>i.done?t(i.value):Promise.resolve(i.value).then(a,l);u((r=r.apply(e,n)).next())});var R=require("dotenv/config"),A=y(require("express")),h=y(require("cors"));var o=require("zod"),d=o.z.object({topic:o.z.string().min(5),userAnswer:o.z.string().min(10),language:o.z.enum(["en","ru"])}),v=o.z.object({feedback:o.z.string(),topicSuggestions:o.z.array(o.z.string())});function I(e){return`
    You are an AI debate coach helping users improve their arguments.

    Given a topic and the user's answer, return:
    1. Constructive feedback
    2. Three follow-up questions to deepen or challenge the answer

    \u2757\uFE0FRespond in JSON. Do not use markdown. No triple backticks. Like this:
    {
      "feedback": "...",
      "topicSuggestions": ["...", "...", "..."]
    }

    Topic: ${e.topic}
    User's answer: ${e.userAnswer}
    Respond in ${e.language}
    `.trim()}function O(e){let n=e.replace(/^\s*```json/,"").replace(/^\s*```/,"").replace(/\s*```$/,"").trim();return JSON.parse(n)}function f(e){return c(this,null,function*(){var t,s;let r=yield(yield fetch("https://api.anthropic.com/v1/messages",{method:"POST",headers:{"Content-Type":"application/json","x-api-key":process.env.ANTHROPIC_API_KEY,"anthropic-version":"2023-06-01"},body:JSON.stringify({model:"claude-3-7-sonnet-20250219",max_tokens:1e3,temperature:.7,messages:[{role:"user",content:I(e)}]})})).json();try{let a=O((s=(t=r.content)==null?void 0:t[0])==null?void 0:s.text);if(typeof a.feedback!="string")throw new Error("Incorrect LLM response in field 'feedback'");if(!Array.isArray(a.topicSuggestions)||a.topicSuggestions.some(l=>typeof l!="string"))throw new Error("Incorrect LLM response in field 'topicSuggestions'");return a}catch(a){throw console.error("Error parsed LLM response"),new Error("Failed to parse Claude's response")}})}var p=(0,A.default)(),w=3e3,x=process.env.ANTHROPIC_API_KEY;p.use((0,h.default)());p.use(A.default.json());p.post("/api/analyze-answer",(e,n)=>c(null,null,function*(){let r=d.safeParse(e.body);if(!r.success){n.status(400).json({error:"Invalid request body",details:r.error.flatten()});return}let t=yield f({language:"ru",topic:"\u0421\u0442\u043E\u0438\u0442 \u043B\u0438 \u043E\u0433\u0440\u0430\u043D\u0438\u0447\u0438\u0432\u0430\u0442\u044C \u0434\u0435\u0442\u0435\u0439 \u0432 \u0438\u0441\u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u043D\u0438\u0438 \u0433\u0430\u0434\u0436\u0435\u0442\u043E\u0432",userAnswer:"\u041D\u0435\u0442, \u043E\u0433\u0440\u0430\u043D\u0438\u0447\u0438\u0432\u0430\u0442\u044C \u0434\u0435\u0442\u0435\u0439 \u0432 \u0438\u0441\u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u043D\u0438\u0438 \u0433\u0430\u0434\u0436\u0435\u0442\u043E\u0432 \u043D\u0435 \u043D\u0443\u0436\u043D\u043E. \u0421\u043E\u0432\u0440\u0435\u043C\u0435\u043D\u043D\u044B\u0435 \u0434\u0435\u0442\u0438 \u0431\u0443\u043A\u0432\u0430\u043B\u044C\u043D\u043E \u0440\u043E\u0436\u0434\u0430\u044E\u0442\u0441\u044F \u0441 \u043F\u043B\u0430\u043D\u0448\u0435\u0442\u043E\u043C \u0432 \u0440\u0443\u043A\u0430\u0445 \u2014 \u0437\u0430\u0447\u0435\u043C \u043C\u0435\u0448\u0430\u0442\u044C \u0435\u0441\u0442\u0435\u0441\u0442\u0432\u0435\u043D\u043D\u043E\u043C\u0443 \u043E\u0442\u0431\u043E\u0440\u0443? \u0414\u0430\u0436\u0435 \u043C\u043B\u0430\u0434\u0435\u043D\u0446\u044B \u0438\u043D\u0442\u0443\u0438\u0442\u0438\u0432\u043D\u043E \u0441\u0432\u0430\u0439\u043F\u0430\u044E\u0442 \u044D\u043A\u0440\u0430\u043D\u044B, \u0430 \u0448\u043A\u043E\u043B\u044C\u043D\u0438\u043A\u0438 \u043C\u043E\u0433\u0443\u0442 \u043E\u0431\u043E\u0439\u0442\u0438 \u0440\u043E\u0434\u0438\u0442\u0435\u043B\u044C\u0441\u043A\u0438\u0439 \u043A\u043E\u043D\u0442\u0440\u043E\u043B\u044C \u0431\u044B\u0441\u0442\u0440\u0435\u0435, \u0447\u0435\u043C \u0442\u044B \u043D\u0430\u0439\u0434\u0451\u0448\u044C \u043A\u043D\u043E\u043F\u043A\u0443 \u0432\u043A\u043B\u044E\u0447\u0435\u043D\u0438\u044F. \u0413\u0430\u0434\u0436\u0435\u0442\u044B \u2014 \u044D\u0442\u043E \u0438\u0445 \u044F\u0437\u044B\u043A, \u0438\u0445 \u0441\u0440\u0435\u0434\u0430, \u0438\u0445 \u0441\u0438\u043B\u0430. \u0412\u043C\u0435\u0441\u0442\u043E \u0442\u043E\u0433\u043E \u0447\u0442\u043E\u0431\u044B \u0437\u0430\u0431\u0438\u0440\u0430\u0442\u044C \u0443\u0441\u0442\u0440\u043E\u0439\u0441\u0442\u0432\u0430, \u043B\u0443\u0447\u0448\u0435 \u0441\u043C\u0438\u0440\u0438\u0442\u044C\u0441\u044F: \u043E\u043D\u0438 \u0432\u0441\u0451 \u0440\u0430\u0432\u043D\u043E \u043D\u0430\u0443\u0447\u0430\u0442\u0441\u044F, \u043F\u0440\u043E\u0441\u0442\u043E \u0431\u0435\u0437 \u0442\u0435\u0431\u044F."});n.send(t)}));p.get("/",(e,n)=>c(null,null,function*(){n.send(`I'm ok. Anthropic API_KEY exists: ${x!==void 0}`)}));p.listen(w,()=>{console.log(`Server is running on http://localhost:${w}`)});
